name: Test SSH Connection and Deploy

on:
  push:
    branches:
      - main

jobs:
  test_ssh:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: List Files in Workspace
      run: ls -R

    - name: Test SSH Connection
      env:
        HOST_NAME: ${{ secrets.SERVER_HOST_NAME }}
        KEY_NAME: ${{ secrets.SERVER_KEY_NAME }}
        IP_ADDRESS: ${{ secrets.IP_ADDRESS }}
      run: |
        mkdir -p ~/.ssh
        echo "$KEY_NAME" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh -vvv -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $HOST_NAME@$IP_ADDRESS 'echo "Connected successfully"'

    - name: Copy Files to Server
      env:
        HOST_NAME: ${{ secrets.SERVER_HOST_NAME }}
        KEY_NAME: ${{ secrets.SERVER_KEY_NAME }}
        IP_ADDRESS: ${{ secrets.IP_ADDRESS }}
      run: |
        scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -r ./my-repo $HOST_NAME@$IP_ADDRESS:~/home/azureuser

    - name: Deploy Application
      env:
        HOST_NAME: ${{ secrets.SERVER_HOST_NAME }}
        KEY_NAME: ${{ secrets.SERVER_KEY_NAME }}
        IP_ADDRESS: ${{ secrets.IP_ADDRESS }}
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa $HOST_NAME@$IP_ADDRESS << 'EOF'
          echo "Deploying application on VM"
          sudo apt update
          sudo apt install -y python3-venv python3-pip
          python3 -m venv ~/my-repo/myenv
          source ~/my-repo/myenv/bin/activate
          pip install --upgrade pip
          pip install gunicorn
          gunicorn app:app --bind 0.0.0.0:5000 --daemon
        EOF
